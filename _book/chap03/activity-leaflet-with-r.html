<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>6 Activity: Leaflet with R | Module 3 Making sense of spatial data</title>
  <meta name="description" content="This is the third module in the FIT5147 Data Exploration and Visualisation unit. In this module you will learn about common graphics for showing spatial data. That is, data that is naturally associated with a geographic location or region and for which you want to explore the data taking this association into account.">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="6 Activity: Leaflet with R | Module 3 Making sense of spatial data" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is the third module in the FIT5147 Data Exploration and Visualisation unit. In this module you will learn about common graphics for showing spatial data. That is, data that is naturally associated with a geographic location or region and for which you want to explore the data taking this association into account." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Activity: Leaflet with R | Module 3 Making sense of spatial data" />
  
  <meta name="twitter:description" content="This is the third module in the FIT5147 Data Exploration and Visualisation unit. In this module you will learn about common graphics for showing spatial data. That is, data that is naturally associated with a geographic location or region and for which you want to explore the data taking this association into account." />
  

<meta name="author" content="Kimbal Marriott">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="activity-shape-files-maps-with-r.html">
<link rel="next" href="activity-introduction-to-mapbox.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />










<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">Module 3 Making sense of spatial data</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Making sense of spatial data: Overview</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#aims-of-this-module"><i class="fa fa-check"></i><b>1.1</b> Aims of this module</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#how-to-study-for-this-module"><i class="fa fa-check"></i><b>1.2</b> How to study for this module</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html"><i class="fa fa-check"></i><b>2</b> How to design a data map</a><ul>
<li class="chapter" data-level="2.1" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#scale-and-generalisation"><i class="fa fa-check"></i><b>2.1</b> Scale and generalisation</a></li>
<li class="chapter" data-level="2.2" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#coordinate-system"><i class="fa fa-check"></i><b>2.2</b> Coordinate system</a></li>
<li class="chapter" data-level="2.3" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#map-projections"><i class="fa fa-check"></i><b>2.3</b> Map projections</a></li>
<li class="chapter" data-level="2.4" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#choice-of-data-map"><i class="fa fa-check"></i><b>2.4</b> Choice of data map</a><ul>
<li class="chapter" data-level="" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#choropleth-and-prism"><i class="fa fa-check"></i>Choropleth and prism</a></li>
<li class="chapter" data-level="" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#dot-density"><i class="fa fa-check"></i>Dot density</a></li>
<li class="chapter" data-level="" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#proportional-symbol"><i class="fa fa-check"></i>Proportional symbol</a></li>
<li class="chapter" data-level="" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#contour-isarithmic-three-dimensional-maps"><i class="fa fa-check"></i>Contour (isarithmic) &amp; three-dimensional maps</a></li>
<li class="chapter" data-level="" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#cartograms"><i class="fa fa-check"></i>Cartograms</a></li>
<li class="chapter" data-level="" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#flow-maps"><i class="fa fa-check"></i>Flow maps</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#choice-of-classes"><i class="fa fa-check"></i><b>2.5</b> Choice of classes</a></li>
<li class="chapter" data-level="2.6" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#aggregation-and-clustering"><i class="fa fa-check"></i><b>2.6</b> Aggregation and clustering</a></li>
<li class="chapter" data-level="2.7" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#spatial-autocorrelation"><i class="fa fa-check"></i><b>2.7</b> Spatial autocorrelation</a></li>
<li class="chapter" data-level="2.8" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#multivariate-visualisation"><i class="fa fa-check"></i><b>2.8</b> Multivariate visualisation</a></li>
<li class="chapter" data-level="2.9" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#uncertainty"><i class="fa fa-check"></i><b>2.9</b> Uncertainty</a></li>
<li class="chapter" data-level="2.10" data-path="how-to-design-a-data-map.html"><a href="how-to-design-a-data-map.html#summary"><i class="fa fa-check"></i><b>2.10</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="overview-of-tools-for-creating-data-maps.html"><a href="overview-of-tools-for-creating-data-maps.html"><i class="fa fa-check"></i><b>3</b> Overview of tools for creating data maps</a><ul>
<li class="chapter" data-level="3.1" data-path="overview-of-tools-for-creating-data-maps.html"><a href="overview-of-tools-for-creating-data-maps.html#gis"><i class="fa fa-check"></i><b>3.1</b> GIS</a></li>
<li class="chapter" data-level="3.2" data-path="overview-of-tools-for-creating-data-maps.html"><a href="overview-of-tools-for-creating-data-maps.html#gis-tools-resources"><i class="fa fa-check"></i><b>3.2</b> GIS tools &amp; resources</a></li>
<li class="chapter" data-level="3.3" data-path="overview-of-tools-for-creating-data-maps.html"><a href="overview-of-tools-for-creating-data-maps.html#gis-data-formats"><i class="fa fa-check"></i><b>3.3</b> GIS data formats</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html"><i class="fa fa-check"></i><b>4</b> Activity: Maps &amp; data with R</a><ul>
<li class="chapter" data-level="4.1" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html#spatial-visualization-with-r-aka-maps"><i class="fa fa-check"></i><b>4.1</b> Spatial Visualization with R AKA maps</a><ul>
<li class="chapter" data-level="" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html#location-location-location"><i class="fa fa-check"></i>Location, location, location</a></li>
<li class="chapter" data-level="" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html#latitude-longitude"><i class="fa fa-check"></i>Latitude &amp; longitude</a></li>
<li class="chapter" data-level="" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html#google-maps"><i class="fa fa-check"></i>Google Maps</a></li>
<li class="chapter" data-level="" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html#try-some-projections"><i class="fa fa-check"></i>Try some projections</a></li>
<li class="chapter" data-level="" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html#x-marker-on-the-map"><i class="fa fa-check"></i>‘X’ marker on the map</a></li>
<li class="chapter" data-level="" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html#label-the-map"><i class="fa fa-check"></i>Label the map</a></li>
<li class="chapter" data-level="" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html#data-on-a-map-using-quick-map-plot"><i class="fa fa-check"></i>Data on a map using quick map plot</a></li>
<li class="chapter" data-level="" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html#choropleth-map"><i class="fa fa-check"></i>Choropleth Map</a></li>
<li class="chapter" data-level="" data-path="activity-maps-data-with-r.html"><a href="activity-maps-data-with-r.html#flow-map"><i class="fa fa-check"></i>Flow Map</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="activity-shape-files-maps-with-r.html"><a href="activity-shape-files-maps-with-r.html"><i class="fa fa-check"></i><b>5</b> Activity: Shape files &amp; maps with R</a><ul>
<li class="chapter" data-level="" data-path="activity-shape-files-maps-with-r.html"><a href="activity-shape-files-maps-with-r.html#shapefiles"><i class="fa fa-check"></i>Shapefiles</a></li>
<li class="chapter" data-level="" data-path="activity-shape-files-maps-with-r.html"><a href="activity-shape-files-maps-with-r.html#lets-do-a-shape-file-on-a-map"><i class="fa fa-check"></i>Let’s do a shape file on a map</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="activity-leaflet-with-r.html"><a href="activity-leaflet-with-r.html"><i class="fa fa-check"></i><b>6</b> Activity: Leaflet with R</a><ul>
<li class="chapter" data-level="6.1" data-path="activity-leaflet-with-r.html"><a href="activity-leaflet-with-r.html#introduction"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="activity-leaflet-with-r.html"><a href="activity-leaflet-with-r.html#marker"><i class="fa fa-check"></i><b>6.2</b> Marker</a></li>
<li class="chapter" data-level="6.3" data-path="activity-leaflet-with-r.html"><a href="activity-leaflet-with-r.html#choropleth-map-1"><i class="fa fa-check"></i><b>6.3</b> Choropleth Map</a></li>
<li class="chapter" data-level="6.4" data-path="activity-leaflet-with-r.html"><a href="activity-leaflet-with-r.html#work-with-shiny"><i class="fa fa-check"></i><b>6.4</b> Work with Shiny</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html"><i class="fa fa-check"></i><b>7</b> Activity: Introduction to Mapbox</a><ul>
<li class="chapter" data-level="7.1" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html#what-is-mapbox"><i class="fa fa-check"></i><b>7.1</b> What is MapBox?</a></li>
<li class="chapter" data-level="7.2" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html#what-do-i-need-to-do"><i class="fa fa-check"></i><b>7.2</b> What do I need to do?</a></li>
<li class="chapter" data-level="7.3" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html#how-do-i-sign-up"><i class="fa fa-check"></i><b>7.3</b> How do I sign up?</a></li>
<li class="chapter" data-level="7.4" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html#mapbox-studio-intro"><i class="fa fa-check"></i><b>7.4</b> Mapbox Studio Intro</a></li>
<li class="chapter" data-level="7.5" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html#exercises"><i class="fa fa-check"></i><b>7.5</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html#a-create-a-customized-map"><i class="fa fa-check"></i>5.1a Create a customized map</a></li>
<li class="chapter" data-level="" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html#b-create-a-customized-map-using-cartogram"><i class="fa fa-check"></i>5.1b Create a customized map using Cartogram</a></li>
<li class="chapter" data-level="" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html#a-work-with-your-data"><i class="fa fa-check"></i>5.2a Work with your data</a></li>
<li class="chapter" data-level="" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html#b-add-the-data-points-to-your-custom-map"><i class="fa fa-check"></i>5.2b Add the data points to your custom map</a></li>
<li class="chapter" data-level="" data-path="activity-introduction-to-mapbox.html"><a href="activity-introduction-to-mapbox.html#c-make-your-pointers-interactive"><i class="fa fa-check"></i>5.2c Make your pointers interactive</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Module 3 Making sense of spatial data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="activity-leaflet-with-r" class="section level1">
<h1><span class="header-section-number">6</span> Activity: Leaflet with R</h1>
<div id="introduction" class="section level2">
<h2><span class="header-section-number">6.1</span> Introduction</h2>
<p>Leaflet is an open-source JavaScript library for <strong>interactive</strong> maps.</p>
<p>A basic interactive map (pan &amp; zoom &amp; markers &amp; etc…) can be created very easily with <code>leaflet</code>.</p>
<p>The <code>leaflet</code> R package allows you to use Leaflet interactive maps in R in an easy way.</p>
<p>We start by installing the package “<code>leaflet</code>“.</p>
<p>Let’s start mapping….</p>
<p>The very first map with leaflet.</p>
<pre class="sourceCode r"><code class="sourceCode r">m &lt;-<span class="st"> </span><span class="kw">leaflet</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">setView</span>(<span class="dt">lng =</span> <span class="fl">145.0431</span>, <span class="dt">lat =</span> <span class="fl">-37.8773</span>, <span class="dt">zoom =</span> <span class="dv">15</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">addTiles</span>()
m</code></pre>
<p>If there is an error of cannot find “httpuv” library, please install it and run the code again.</p>
<p>There is a very “modern” way to use leaflet with the %&gt;% operation.</p>
<p>The basic idea is to use <strong>the result of the</strong> <strong><em>previous function</em></strong> as <strong>the first parameter of the</strong> <strong><em>next function</em></strong>.</p>
<p>Check <a href="https://github.com/tidyverse/magrittr">magrittr pipe operator</a> for details.</p>
<p>Or we can do it in the old fashioned way:</p>
<pre class="sourceCode r"><code class="sourceCode r">m &lt;-<span class="st"> </span><span class="kw">leaflet</span>() 
m &lt;-<span class="st"> </span><span class="kw">setView</span>(m, <span class="dt">lng =</span> <span class="fl">145.0431</span>, <span class="dt">lat =</span> <span class="fl">-37.8773</span>, <span class="dt">zoom =</span> <span class="dv">15</span>)
m &lt;-<span class="st"> </span><span class="kw">addTiles</span>(m)
m</code></pre>
<p>You may already notice, the map is plotted in the “Viewer” tab instead of the normal “Plots” tab.</p>
<p>This is because the leaflet R package is still using the leaflet javascript package and the “Viewer” tab is basically a small web browser.</p>
<p>You can also customise your tile.</p>
<pre class="sourceCode r"><code class="sourceCode r">m <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">addProviderTiles</span>(<span class="st">&quot;Stamen.Toner&quot;</span>)</code></pre>
<p>use <code>help(addProviderTiles)</code> to check other available tiles.</p>
</div>
<div id="marker" class="section level2">
<h2><span class="header-section-number">6.2</span> Marker</h2>
<p>The data is ready for you in: <a href="diagrams_datasets/section6/vet_schools_in_victoria.txt">vet_schools_in_victoria</a>.</p>
<p>Load it as usual and have a look.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(leaflet)
data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;vet_schools_in_victoria.txt&quot;</span>)
<span class="kw">head</span>(data)</code></pre>
<p>This data set is very large.</p>
<p>Let’s place the first 30 records on the map first.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">leaflet</span>(<span class="dt">data =</span> data[<span class="dv">1</span><span class="op">:</span><span class="dv">30</span>, ]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">addTiles</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">addMarkers</span>(<span class="op">~</span>longitude, <span class="op">~</span>latitude, <span class="dt">popup =</span> <span class="op">~</span><span class="kw">as.character</span>(location)) </code></pre>
<p>Click on the markers, find out what’s the text about.</p>
<p>Try the whole data set.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">leaflet</span>(<span class="dt">data =</span> data) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">addTiles</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">addMarkers</span>(<span class="op">~</span>longitude, <span class="op">~</span>latitude, <span class="dt">popup =</span> <span class="op">~</span><span class="kw">as.character</span>(location)) </code></pre>
<p>That’s terrible…</p>
<p>But our map is interactive, we should be able to cluster the data and allow the user to zoom into the details.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">leaflet</span>(<span class="dt">data =</span> data) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">addTiles</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">addMarkers</span>(
    <span class="op">~</span>longitude, 
    <span class="op">~</span>latitude, 
    <span class="dt">popup =</span> <span class="op">~</span><span class="kw">as.character</span>(location),
    <span class="dt">clusterOptions =</span> <span class="kw">markerClusterOptions</span>()
  )</code></pre>
</div>
<div id="choropleth-map-1" class="section level2">
<h2><span class="header-section-number">6.3</span> Choropleth Map</h2>
<p>Download our familiar data set again: <a href="diagrams_datasets/section6/Household-heating-by-State-2008.csv">Household-heating-by-State-2008.csv</a>.</p>
<p>Let’s pre-process the data as usual.</p>
<pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;Household-heating-by-State-2008.csv&quot;</span>, <span class="dt">header=</span>T) 
<span class="kw">names</span>(data)[<span class="dv">4</span>] &lt;-<span class="st"> &quot;MobileHomes&quot;</span>
ag &lt;-<span class="st"> </span><span class="kw">aggregate</span>(MobileHomes <span class="op">~</span><span class="st"> </span>States, <span class="dt">FUN =</span> mean, <span class="dt">data =</span> data)
ag<span class="op">$</span>States &lt;-<span class="st"> </span><span class="kw">tolower</span>(ag<span class="op">$</span>States)</code></pre>
<p>Let’s prepare the map data and link the two data sets.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(maps)
mapStates &lt;-<span class="st"> </span><span class="kw">map</span>(<span class="st">&quot;state&quot;</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">plot =</span> <span class="ot">FALSE</span>)
<span class="co"># find the related rate for each state</span>
rates &lt;-<span class="st"> </span>ag<span class="op">$</span>MobileHomes[<span class="kw">match</span>(mapStates<span class="op">$</span>names, ag<span class="op">$</span>States)] </code></pre>
<p>Now, it is time to use <code>leaflet</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(leaflet)
cpal &lt;-<span class="st"> </span><span class="kw">colorNumeric</span>(<span class="st">&quot;Blues&quot;</span>, rates) <span class="co"># prepare the color mapping</span>
<span class="kw">leaflet</span>(mapStates) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># create a blank canvas</span>
<span class="st">  </span><span class="kw">addTiles</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># add tile</span>
<span class="st">  </span><span class="kw">addPolygons</span>( <span class="co"># draw polygons on top of the base map (tile)</span>
    <span class="dt">stroke =</span> <span class="ot">FALSE</span>, 
    <span class="dt">smoothFactor =</span> <span class="fl">0.2</span>, 
    <span class="dt">fillOpacity =</span> <span class="dv">1</span>,
    <span class="dt">color =</span> <span class="op">~</span><span class="kw">cpal</span>(rates) <span class="co"># use the rate of each state to find the correct color</span>
  ) </code></pre>
<p>You may also notice some parts are not colored.</p>
<p>Let’s check out why.</p>
<pre class="sourceCode r"><code class="sourceCode r">mapStates<span class="op">$</span>names
ag<span class="op">$</span>States</code></pre>
<p><img src="diagrams_datasets/section6/leaflet-01.png" /></p>
<p>As you can see, “washington” is split into different parts in <code>mapState</code>, and so the strings do not match.</p>
<p><strong>Data processing</strong> again.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># split the string with : as seperator</span>
spliteNames &lt;-<span class="st"> </span><span class="kw">strsplit</span>(mapStates<span class="op">$</span>names, <span class="st">&quot;:&quot;</span>) 
<span class="co"># get first part of the origin string;</span>
<span class="co"># e.g. get washington from washington:san juan island</span>
firstPartNames &lt;-<span class="st"> </span><span class="kw">lapply</span>(spliteNames, <span class="cf">function</span>(x) x[<span class="dv">1</span>])  
rates &lt;-<span class="st"> </span>ag<span class="op">$</span>MobileHomes[<span class="kw">match</span>(firstPartNames, ag<span class="op">$</span>States)]</code></pre>
<p>Now plot again.</p>
<pre class="sourceCode r"><code class="sourceCode r">cpal &lt;-<span class="st"> </span><span class="kw">colorNumeric</span>(<span class="st">&quot;Blues&quot;</span>, rates) <span class="co"># prepare the color mapping</span>
<span class="kw">leaflet</span>(mapStates) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># create a blank canvas</span>
<span class="st">  </span><span class="kw">addTiles</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># add tile</span>
<span class="st">  </span><span class="kw">addPolygons</span>( <span class="co"># draw polygons on top of the base map (tile)</span>
    <span class="dt">stroke =</span> <span class="ot">FALSE</span>, 
    <span class="dt">smoothFactor =</span> <span class="fl">0.2</span>, 
    <span class="dt">fillOpacity =</span> <span class="dv">1</span>,
    <span class="dt">color =</span> <span class="op">~</span><span class="kw">cpal</span>(rates) <span class="co"># use the rate of each state to find the correct color</span>
  )</code></pre>
<p>Compare it with creating choropleth map in <strong>R</strong> using in previous activities, <strong>Google Fusion Table</strong> and <strong>Tableau</strong>. Which one do you prefer and <strong>WHY</strong>?</p>
<p>Here, we are using the built-in map data <code>map("state", fill = TRUE, plot = FALSE)</code>, if you cannot find your map data in the built-in maps, <code>leaflet</code> can also handle shapefiles.</p>
<p>You will need <code>rgdal</code> library to read your shapefile and it is available at: <a href="diagrams_datasets/section6/ne_50m_admin_0_countries.zip">World shape file</a>.</p>
<p>Unzip it and put the very important 3 files (ne_50m_admin_0_countries.shp &amp; shx &amp; dbf) into your working directory.</p>
<p>Also we need the data for colors. Here we provide <a href="diagrams_datasets/section6/WorldGDP.txt">the GPD data for countries</a>.</p>
<p>Reading the data first, there are different ways to load the data.</p>
<p>If you cannot read the map, it is because of different file path system on different operating systems.</p>
<p>Have a try with the other way.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rgdal)
world_map &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="st">&quot;ne_50m_admin_0_countries.shp&quot;</span>)
gdp_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;WorldGDP.txt&quot;</span>)</code></pre>
<p>OR</p>
<pre class="sourceCode r"><code class="sourceCode r">world_map &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;ne_50m_admin_0_countries&quot;</span>)</code></pre>
<p><br><br></p>
<p>Match the gdp to each country.</p>
<pre class="sourceCode r"><code class="sourceCode r">rates &lt;-<span class="st"> </span>gdp_data<span class="op">$</span>GDP[<span class="kw">match</span>(world_map<span class="op">$</span>admin, gdp_data<span class="op">$</span>Name)]</code></pre>
<p>Create the map</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(leaflet)
qpal &lt;-<span class="st"> </span><span class="kw">colorQuantile</span>(<span class="st">&quot;Blues&quot;</span>, rates, <span class="dv">12</span>) <span class="co"># prepare the color mapping</span>
 
<span class="kw">leaflet</span>(world_map) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># create a blank canvas</span>
<span class="st">  </span><span class="kw">addTiles</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># add tile</span>
<span class="st">  </span><span class="kw">addPolygons</span>( <span class="co"># draw polygons on top of the base map (tile)</span>
    <span class="dt">stroke =</span> <span class="ot">FALSE</span>, 
    <span class="dt">smoothFactor =</span> <span class="fl">0.2</span>, 
    <span class="dt">fillOpacity =</span> <span class="dv">1</span>,
    <span class="dt">color =</span> <span class="op">~</span><span class="kw">qpal</span>(rates) <span class="co"># use the rate of each state to find the correct color</span>
  )</code></pre>
<p>If you read carefully enough, you may find two different functions are used for color mapping.</p>
<ul>
<li>colorQuantile</li>
<li>colorNumeric</li>
</ul>
<p>Investigate what’s the difference between them.</p>
<p><br><br></p>
<p>There is also some mismatching…</p>
<p>The reason might be the same as our previous US one, can you fix it?</p>
<p>Also be careful with your own data!</p>
</div>
<div id="work-with-shiny" class="section level2">
<h2><span class="header-section-number">6.4</span> Work with Shiny</h2>
<p><code>Leaflet</code> can also integrate into your Shiny app easily.</p>
<p>Here, we are also introducing a new way to write a Shiny app, with all the code in one file.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(leaflet)
 
ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="co"># create map canvas on the page</span>
  <span class="kw">leafletOutput</span>(<span class="st">&quot;mymap&quot;</span>), 
  <span class="co"># create a button, and bind it to the recalc event</span>
  <span class="kw">actionButton</span>(<span class="st">&quot;recalc&quot;</span>, <span class="st">&quot;New points&quot;</span>) 
)
 
server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  <span class="co"># event handle, in this case for click event</span>
  points &lt;-<span class="st"> </span><span class="kw">eventReactive</span>(input<span class="op">$</span>recalc, { 
    <span class="co"># calculate normal distribution random points around Melbourne</span>
    <span class="kw">cbind</span>(<span class="kw">rnorm</span>(<span class="dv">40</span>) <span class="op">*</span><span class="st"> </span><span class="dv">3</span> <span class="op">+</span><span class="st"> </span><span class="fl">145.0431</span>, <span class="kw">rnorm</span>(<span class="dv">40</span>) <span class="fl">-37.8773</span>) 
  }, <span class="dt">ignoreNULL =</span> <span class="ot">FALSE</span>)
   
  output<span class="op">$</span>mymap &lt;-<span class="st"> </span><span class="kw">renderLeaflet</span>({ <span class="co"># create leaflet map</span>
    <span class="kw">leaflet</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">addTiles</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="co"># use the random generated points as markers on the map</span>
<span class="st">      </span><span class="kw">addMarkers</span>(<span class="dt">data =</span> <span class="kw">points</span>()) 
  })
}
 
<span class="kw">shinyApp</span>(ui, server)</code></pre>
<p>Create a new file and paste the above code to your RStudio (and understand it!).</p>
<p>Create a new file and paste the above code to your RStudio (and understand it!).</p>
<p>More details on the integration with Shiny is available at: <a href="https://rstudio.github.io/leaflet/shiny.html" class="uri">https://rstudio.github.io/leaflet/shiny.html</a> (the D section is also based on this material).</p>
<hr />

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="activity-shape-files-maps-with-r.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="activity-introduction-to-mapbox.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "Module"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
